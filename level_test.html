<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kindo - Level Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    <style>
        body {
            font-family: 'Open Sans', sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .device-frame {
            width: 100%;
            max-width: 414px;
            height: 100vh;
            max-height: 896px;
            background-color: #FEFEFE;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            border-radius: 38px;
            box-sizing: border-box;
        }
        

        .page-content-wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
            position: relative;
        }

        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 5px;
        }
        .test-title {
            font-size: 22px;
            font-weight: 700;
            color: #1F2937;
        }
        .close-test-button {
            background: none;
            border: none;
            font-size: 28px;
            font-weight: 300;
            color: #6B7280;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .test-progress-bar-container {
            width: 100%;
            display: flex;
            justify-content: space-between;
            gap: 6px;
            margin-bottom: 20px;
            padding: 0 5px;
        }

        .test-progress-segment {
            height: 5px;
            flex-grow: 1;
            background-color: #E5E7EB;
            border-radius: 2.5px;
            transition: background-color 0.3s ease;
        }

        .test-progress-segment.active {
            background-color: #374151;
        }
        .test-progress-segment.answered-correct {
            background-color: #10B981;
        }
        .test-progress-segment.answered-incorrect {
            background-color: #EF4444;
        }
         .test-progress-segment.answered-skipped {
            background-color: #9CA3AF;
        }

        .test-question-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        .test-question-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            width: 100%;
            padding: 0 5px;
        }

        .test-mascot-icon {
            width: 40px;
            height: 40px;
            flex-shrink: 0;
        }
        .test-mascot-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .test-instruction-bubble {
            background-color: #F3F4F6;
            padding: 10px 16px;
            border-radius: 12px;
            flex-grow: 1;
        }
        .test-instruction-text {
            font-size: 16px;
            font-weight: 500;
            color: #374151;
        }
        .audio-speed-note, .pronunciation-sample-note {
            font-size: 12px;
            color: #6B7280;
            margin-top: 4px;
            text-align: center;
            width: 100%;
            margin-bottom: 16px;
        }

        .test-stimulus-container {
            margin-bottom: 16px;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
        }
        .test-image {
            width: 120px;
            height: 120px;
            object-fit: contain;
        }
        .test-text-stimulus, .pronunciation-text-stimulus, .sentence-stimulus {
            font-size: 32px;
            font-weight: 600;
            color: #1F2937;
            text-align: center;
        }
        .sentence-stimulus {
            margin-bottom: 24px;
        }

        .audio-controls {
            display: flex;
            align-items: center;
            gap: 16px;
            width: 100%;
            justify-content: center;
            margin-top: 16px;
        }
        .audio-controls-horizontal {
             flex-direction: row;
             justify-content: center;
        }
        .pronunciation-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            width: 100%;
        }


        .play-sample-button, .speak-button {
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            width: 100%;
            transition: background-color 0.2s;
        }
        .play-sample-button {
            background-color: #E5E7EB;
            color: #374151;
        }
        .play-sample-button:disabled, .speak-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            pointer-events: none;
        }
        .play-sample-button:disabled {
             background-color: #D1D5DB;
        }

        .speak-button.default { background-color: #F97316; }
        .speak-button.listening { background-color: #6B7280; }
        .speak-button.processing { background-color: #1F2937; color: white; }
        .speak-button.correct { background-color: #10B981; }
        .speak-button.incorrect { background-color: #EF4444; }
        .speak-button .icon {
            margin-right: 8px;
            flex-shrink: 0;
        }


        .audio-speed-button {
            background-color: #E5E7EB;
            color: #374151;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            min-width: 100px;
            text-align: center;
        }
         .audio-speed-button:disabled {
            background-color: #F3F4F6;
            color: #9CA3AF;
            cursor: not-allowed;
            pointer-events: none;
        }

        .writing-input-field {
            width: 144px;
            padding: 10px 16px;
            border: 1px solid #D1D5DB;
            border-radius: 8px;
            font-size: 18px;
            color: #1F2937;
            text-align: center;
            box-sizing: border-box;
            line-height: normal;
        }


        .test-options-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 0 5px;
            margin-bottom: auto;
        }

        .test-option-card {
            background-color: #F9FAFB;
            border: 1px solid #F3F4F6;
            border-radius: 12px;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            cursor: pointer;
            transition: border-color 0.2s, background-color 0.2s, color 0.2s;
            font-size: 18px;
            font-weight: 500;
            color: #374151;
            text-align: left;
        }
        .test-option-card.selected {
            border-color: #374151;
            background-color: #374151;
            color: white;
        }

        /* Styles for Translation Question Type */
        .user-translation-area {
            width: 100%;
            min-height: 50px;
            background-color: #F9FAFB;
            border: 1px dashed #D1D5DB;
            border-radius: 12px;
            padding: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
            align-items: center;
            justify-content: center;
        }
        .word-pill {
            background-color: #374151;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .word-bank-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            padding: 10px 0;
        }
        .word-bank-button {
            background-color: #F3F4F6;
            color: #374151;
            padding: 10px 15px;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s, opacity 0.2s;
        }
        .word-bank-button:hover {
            background-color: #E5E7EB;
        }
        .word-bank-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #F9FAFB;
        }

        /* Styles for Matching Pairs Question Type */
        .matching-pairs-container {
            display: flex;
            justify-content: space-between;
            width: 100%;
            gap: 20px;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        .matching-column {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex: 1;
        }
        .matching-item {
            background-color: #F3F4F6;
            border: 2px solid #E5E7EB;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            font-size: 16px;
            font-weight: 500;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s ease-out;
        }
        .matching-item.selected {
            border-color: #F97316;
            background-color: #FFF8F1;
        }
        .matching-item.correct {
            border-color: #10B981;
            background-color: #D1FAE5;
            color: #065F46;
            cursor: not-allowed;
            opacity: 0.8;
        }
        .matching-item.incorrect {
            border-color: #EF4444;
            background-color: #FEE2E2;
            color: #991B1B;
        }
        .matching-item:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }


        .test-navigation-footer {
            width: 100%;
            padding: 0 5px;
            margin-top: 20px;
        }
        .check-button, .pronunciation-continue-button {
            width: 100%;
            padding: 14px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s;
            border: none;
        }
        .check-button {
            background-color: #FFF8F1;
            color: #EA8934;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -1px rgba(0,0,0,0.03);
        }
        .check-button:hover {
            background-color: #FEEEDA;
            color: #EA8934;
        }
        .check-button:active {
            background-color: #FCD1A8;
            color: #EA8934;
        }
        .check-button.disabled, .pronunciation-continue-button.disabled {
            background-color: #E5E7EB !important;
            color: #9CA3AF !important;
            cursor: not-allowed;
            pointer-events: none;
        }
        .pronunciation-continue-button {
            background-color: #F97316;
            color: white;
            margin-top: 16px;
        }
        .pronunciation-skip-link {
            display: block;
            text-align: center;
            color: #6B7280;
            font-size: 14px;
            margin-top: 16px;
            cursor: pointer;
            text-decoration: underline;
        }


        .result-drawer {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: white;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            box-shadow: 0 -2px 15px rgba(0,0,0,0.15);
            padding: 24px 24px 30px 24px;
            box-sizing: border-box;
            z-index: 70;
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
        }
        .result-drawer.active {
            transform: translateY(0);
        }

        .result-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }
        .result-icon {
            width: 28px;
            height: 28px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        .result-icon.correct { background-color: #10B981; }
        .result-icon.incorrect { background-color: #EF4444; }
        .result-icon svg {
            stroke: white;
            width: 18px;
            height: 18px;
        }

        .result-title {
            font-size: 20px;
            font-weight: 700;
        }
        .result-title.correct { color: #059669; }
        .result-title.incorrect { color: #DC2626; }

        .result-message {
            font-size: 16px;
            color: #374151;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        .result-message strong {
            font-weight: 600;
            color: #1F2937;
        }

        .result-continue-button {
            width: 100%;
            padding: 14px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
            text-align: center;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s;
        }
        .result-continue-button.correct {
            background-color: #10B981;
            color: white;
        }
        .result-continue-button.correct:hover {
            background-color: #059669;
        }
        .result-continue-button.incorrect {
            background-color: #EF4444;
            color: white;
        }
        .result-continue-button.incorrect:hover {
            background-color: #DC2626;
        }

        .start-listening-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 12px;
            background: #EA8934;
            color: white;
            border-radius: 8px;
            flex: 1;
        }

        .start-listening-button:hover {
            background: #D57427;
        }

        .start-listening-button:active {
            background: #B55D1F;
        }

        /* Final Result Screen Styles */
        .final-result-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 20px;
        }
        .final-result-mascot-bubble {
            background-color: #F3F4F6;
            padding: 10px 20px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            color: #1F2937;
            margin-bottom: 20px;
            position: relative;
        }
         .final-result-mascot-bubble.amazing {
            background-color: #FFF8F1;
            color: #EA8934;
        }
        .lottie-animation-container {
            width: 320px;
            height: 320px;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        .your-result-text {
            font-size: 14px;
            font-weight: 500;
            color: #6B7280;
            margin-bottom: 5px;
            text-transform: uppercase;
        }
        .final-score-text {
            font-size: 36px;
            font-weight: 700;
            color: #1F2937;
            margin-bottom: 15px;
        }
        .final-score-text.amazing-score {
            color: #10B981;
        }
        .final-score-text.needs-improvement-score {
            color: #EF4444;
        }
        .final-message-text {
            font-size: 14px;
            color: #4B5563;
            line-height: 1.6;
            margin-bottom: 30px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #F97316;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>
<body>
    <div class="device-frame">
        <div class="page-content-wrapper" id="pageContentWrapper">
            <div class="test-header" id="testHeader">
                <h2 class="test-title">Level Test</h2>
                <button class="close-test-button" id="closeTestButton" aria-label="Close Test">×</button>
            </div>

            <div class="test-progress-bar-container" id="testProgressBar">
                </div>

            <div class="test-question-area" id="testQuestionArea">
                <div class="test-question-header" id="testQuestionHeaderDiv">
                    <div class="test-mascot-icon">
                        <img src="https://res.cloudinary.com/middo-vn/image/upload/v1747204806/Logo-Vertical.png" alt="Kindo Mascot">
                    </div>
                    <div class="test-instruction-bubble">
                        <p class="test-instruction-text" id="testInstructionText"></p>
                    </div>
                </div>
                <div class="audio-speed-note" id="audioSpeedNote" style="display: none;">* You can click the speaker to hear the sample</div>
                <div class="pronunciation-sample-note" id="pronunciationSampleNote" style="display: none;">* You can click the speaker to hear the sample</div>


                <div class="test-stimulus-container" id="testStimulusContainer">
                    </div>
                 <div class="test-options-container" id="testOptionsContainer">
                    </div>
            </div>

            <div class="test-navigation-footer" id="testNavigationFooter">
                </div>

             <div class="result-drawer" id="resultDrawer">
                <div class="result-header">
                    <div class="result-icon" id="resultDrawerIconContainer">
                        </div>
                    <h3 class="result-title" id="resultDrawerTitle"></h3>
                </div>
                <p class="result-message" id="resultDrawerMessage"></p>
                <button type="button" class="result-continue-button" id="resultContinueButton">Continue</button>
            </div>

        </div> </div> <script>
        // Get necessary DOM elements
        const pageContentWrapper = document.getElementById('pageContentWrapper');
        const testHeader = document.getElementById('testHeader');
        const testProgressBar = document.getElementById('testProgressBar');
        const testQuestionArea = document.getElementById('testQuestionArea');
        const testQuestionHeaderDiv = document.getElementById('testQuestionHeaderDiv');
        const testInstructionText = document.getElementById('testInstructionText');
        const testStimulusContainer = document.getElementById('testStimulusContainer');
        const testOptionsContainer = document.getElementById('testOptionsContainer');
        const closeTestButton = document.getElementById('closeTestButton');
        const audioSpeedNote = document.getElementById('audioSpeedNote');
        const pronunciationSampleNote = document.getElementById('pronunciationSampleNote');
        const testNavigationFooter = document.getElementById('testNavigationFooter');

        const resultDrawer = document.getElementById('resultDrawer');
        const resultDrawerIconContainer = document.getElementById('resultDrawerIconContainer');
        const resultDrawerTitle = document.getElementById('resultDrawerTitle');
        const resultDrawerMessage = document.getElementById('resultDrawerMessage');
        const resultContinueButton = document.getElementById('resultContinueButton');

        // Array containing test questions
        const testQuestions = [
            {
                id: 1,
                stimulusType: 'pronunciation',
                textToPronounce: '안녕하세요',
                sampleAudioUrl: "https://res.cloudinary.com/middo-vn/video/upload/v1747280931/mp3-output-ttsfree_dot_com-3.mp3",
                instruction: 'Read this sentence aloud.',
                correctAnswerDisplay: '안녕하세요 (an-nyeong-ha-se-yo): Hello',
            },
            {
                id: 2,
                stimulusType: 'image',
                stimulusContent: "https://res.cloudinary.com/middo-vn/image/upload/v1747275891/apple.png",
                instruction: 'Choose the correct translation',
                options: [
                    { text: '바나나', value: 'banana' },
                    { text: '우유', value: 'milk' },
                    { text: '사과', value: 'apple' },
                    { text: '밥', value: 'rice' }
                ],
                correctAnswerValue: 'apple',
                correctAnswerDisplay: '사과 (sa-gwa): apple'
            },
            {
                id: 3,
                stimulusType: 'text',
                stimulusContent: '저는 학생이에요.',
                instruction: 'Choose the correct translation',
                options: [
                    { text: "I'm a teacher", value: 'teacher' },
                    { text: "I'm a student", value: 'student' },
                    { text: "I'm a doctor", value: 'doctor' },
                    { text: "I'm Korean", value: 'korean' }
                ],
                correctAnswerValue: 'student',
                correctAnswerDisplay: "저는 학생이에요 (jeo-neun hak-saeng-i-e-yo): I'm a student"
            },
            {
                id: 4,
                stimulusType: 'audio_file',
                stimulusContent: "https://res.cloudinary.com/middo-vn/video/upload/v1747275458/mp3-output-ttsfree_dot_com.mp3",
                instruction: 'Choose the correct answer for what you heard',
                options: [
                    { text: '불', value: 'bul' },
                    { text: '물', value: 'mul' },
                    { text: '문', value: 'mun' },
                    { text: '몰', value: 'mol' }
                ],
                correctAnswerValue: 'mul',
                correctAnswerDisplay: '물 (mul): water'
            },
            {
                id: 5,
                stimulusType: 'audio_file',
                stimulusContent: "https://res.cloudinary.com/middo-vn/video/upload/v1747275653/mp3-output-ttsfree_dot_com-2.mp3",
                instruction: 'Choose the correct answer for what you heard',
                options: [
                    { text: "Hello, nice to meet you", value: 'hello' },
                    { text: "My name is Minho", value: 'name' },
                    { text: "Goodbye, see you", value: 'goodbye' },
                    { text: "Thanks a lot", value: 'thanks' }
                ],
                correctAnswerValue: 'hello',
                correctAnswerDisplay: "Hello, nice to meet you (안녕하세요, 만나서 반가워요)"
            },
            {
                id: 6,
                stimulusType: 'pronunciation',
                textToPronounce: '저는 수진입니다',
                sampleAudioUrl: "https://res.cloudinary.com/middo-vn/video/upload/v1747281455/mp3-output-ttsfree_dot_com-4.mp3",
                instruction: 'Read this sentence aloud.',
                correctAnswerDisplay: '저는 수진입니다 (jeo-neun Sujin-imnida): I am Sujin',
            },
            {
                id: 7,
                stimulusType: 'writing',
                audioUrl: "https://res.cloudinary.com/middo-vn/video/upload/v1747281667/mp3-output-ttsfree_dot_com-5.mp3",
                instruction: 'Write the correct answer for what you heard',
                correctAnswerValue: '학교',
                correctAnswerDisplay: '학교 (hak-gyo): school'
            },
            {
                id: 8,
                stimulusType: 'writing',
                textWithBlank: '저는 _____ 먹어요.',
                audioUrl: "https://res.cloudinary.com/middo-vn/video/upload/v1747282411/mp3-output-ttsfree_dot_com-6.mp3",
                instruction: 'Listen and type the missing word to complete the sentence.',
                correctAnswerValue: '김치',
                correctAnswerDisplay: '김치 (gimchi) - 저는 김치 먹어요. (I eat kimchi.)'
            },
            {
                id: 9,
                stimulusType: 'translation',
                koreanSentence: '이 사람은 선생님입니다.',
                instruction: 'Translate this sentence.',
                wordBank: ['This', 'person', 'is', 'a', 'the', 'teacher', 'student', 'Apple', 'he', 'she'],
                correctTranslation: ['This', 'person', 'is', 'a', 'teacher'],
                correctAnswerDisplay: 'This person is a teacher.'
            },
            {
                id: 10,
                stimulusType: 'translation',
                englishSentence: 'I am a student.',
                instruction: 'Translate this sentence.',
                wordBank: ['저는', '사과', '책', '사람', '이다', '먹어요', '학생입니다', '학생', '입니다'],
                correctTranslation: ['저는', '학생', '입니다'],
                correctAnswerDisplay: '저는 학생입니다. (I am a student.)'
            },
            {
                id: 11,
                stimulusType: 'matching_pairs',
                instruction: 'Select the correct pairs.',
                pairs: [
                    { id: 'm_kor1', left: '밥', right: 'Rice', matchId: 'pair1_11' },
                    { id: 'm_kor2', left: '선생님', right: 'Teacher', matchId: 'pair2_11' },
                    { id: 'm_kor3', left: '학생', right: 'Student', matchId: 'pair3_11' },
                    { id: 'm_kor4', left: '물', right: 'Water', matchId: 'pair4_11' }
                ],
                correctAnswerDisplay: 'All pairs matched correctly!'
            },
            {
                id: 12,
                stimulusType: 'matching_pairs',
                instruction: 'Select the correct pairs.',
                pairs: [
                    { id: 'eng1_12', left: 'Apple', right: '사과', matchId: 'pair1_12' },
                    { id: 'eng2_12', left: 'School', right: '학교', matchId: 'pair2_12' },
                    { id: 'eng3_12', left: 'Book', right: '책', matchId: 'pair3_12' },
                    { id: 'eng4_12', left: 'Hello', right: '안녕하세요', matchId: 'pair4_12' }
                ],
                correctAnswerDisplay: 'All pairs matched correctly!'
            }
        ];

        let currentTestQuestionIndex = 0;
        let userResults = new Array(testQuestions.length).fill(null);
        let selectedAnswerValue = null;
        let currentAudioElement = null;
        let currentSpeech = null;
        let currentPlaybackRate = 1.0;
        let recognitionInstance = null;
        const SpeechRecognitionAPI = window.SpeechRecognition || window.webkitSpeechRecognition;
        let silenceTimer = null;
        let isRecognizing = false;
        let userConstructedSentence = [];
        let selectedMatchingItem = { element: null, column: null, value: null, matchId: null };
        let matchedPairCount = 0;


        const iconCorrectSVG = `<svg class="w-full h-full" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>`;
        const iconIncorrectSVG = `<svg class="w-full h-full" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>`;
        const micIconSVG = `<svg class="icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5z"/><path d="M10 8a2 2 0 1 1-4 0V3a2 2 0 1 1 4 0v5zM8 0a3 3 0 0 0-3 3v5a3 3 0 0 0 6 0V3a3 3 0 0 0-3-3z"/></svg>`;
        const checkIconSVG = `<svg class="icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/></svg>`;
        const xIconSVG = `<svg class="icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>`;

        let ttsVoices = [];
        function populateVoiceList() {
          if(typeof speechSynthesis === 'undefined') return;
          ttsVoices = speechSynthesis.getVoices();
          console.log("Available TTS voices:", ttsVoices);
          if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = populateVoiceList;
          }
        }
        populateVoiceList();


        function createProgressBar() {
            testProgressBar.innerHTML = '';
            testQuestions.forEach((_, index) => {
                const segment = document.createElement('div');
                segment.classList.add('test-progress-segment');
                if (index === 0) segment.classList.add('active');
                testProgressBar.appendChild(segment);
            });
        }

        function updateTestProgressBar() {
            const segments = testProgressBar.querySelectorAll('.test-progress-segment');
            segments.forEach((segment, index) => {
                segment.classList.remove('active', 'answered-correct', 'answered-incorrect', 'answered-skipped');
                if (userResults[index] === true) {
                    segment.classList.add('answered-correct');
                } else if (userResults[index] === false) {
                    segment.classList.add('answered-incorrect');
                } else if (userResults[index] === 'skipped') {
                    segment.classList.add('answered-skipped');
                }
                if (index === currentTestQuestionIndex) {
                    segment.classList.add('active');
                }
            });
        }

        function stopAllAudio() {
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }
            if (currentAudioElement && !currentAudioElement.paused) {
                currentAudioElement.pause();
                currentAudioElement.currentTime = 0;
            }
            if (recognitionInstance && isRecognizing) {
                try {
                    recognitionInstance.stop();
                    console.log("Speech recognition stopped by stopAllAudio.");
                } catch(e) {
                    console.warn("Error stopping recognition in stopAllAudio:", e);
                }
                isRecognizing = false;
            }
        }

        function initializeSpeechRecognition(question, speakButton, playSampleButton, pronunciationContinueButton) {
            if (!SpeechRecognitionAPI) {
                speakButton.innerHTML = `<span class="icon">${micIconSVG}</span> Speech Rec. N/A`;
                speakButton.disabled = true;
                pronunciationContinueButton.disabled = false;
                pronunciationContinueButton.classList.remove('disabled');
                alert('Your browser does not support speech recognition. You can skip this question.');
                return null;
            }

            recognitionInstance = new SpeechRecognitionAPI();
            recognitionInstance.continuous = false;
            recognitionInstance.lang = 'ko-KR';
            recognitionInstance.interimResults = true;
            recognitionInstance.maxAlternatives = 1;

            speakButton.onclick = () => {
                if (speechSynthesis.speaking || (currentAudioElement && !currentAudioElement.paused)) {
                    alert('Please wait for the sample audio to finish.');
                    return;
                }
                if (isRecognizing) {
                    console.log("Manually stopping recognition.");
                    if (recognitionInstance) recognitionInstance.stop();
                    return;
                }
                try {
                    speakButton.innerHTML = `<span class="icon">${micIconSVG}</span> Listening...`;
                    speakButton.className = 'speak-button listening';
                    speakButton.disabled = true;
                    playSampleButton.disabled = true;
                    pronunciationContinueButton.disabled = true;
                    pronunciationContinueButton.classList.add('disabled');
                    console.log("Attempting to start speech recognition...");
                    recognitionInstance.start();
                } catch (e) {
                    console.error("Error on trying to start speech recognition:", e);
                    speakButton.innerHTML = `<span class="icon">${micIconSVG}</span> Tap to START SPEAKING`;
                    speakButton.className = 'speak-button default';
                    speakButton.disabled = false;
                    playSampleButton.disabled = false;
                    alert("Could not start voice recognition. Error: " + e.message + ". Please check microphone permissions or try again.");
                }
            };

            recognitionInstance.onstart = () => {
                console.log('Speech recognition service has started.');
                isRecognizing = true;
                speakButton.disabled = false;
                clearTimeout(silenceTimer);
            };

            recognitionInstance.onresult = (event) => {
                clearTimeout(silenceTimer);
                let interimTranscript = '';
                let finalTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
                speakButton.innerHTML = `<span class="icon">${micIconSVG}</span> ${interimTranscript || finalTranscript || "Processing..."}`;
                speakButton.className = 'speak-button processing';

                if (finalTranscript) {
                    console.log('User said (final):', finalTranscript);
                    const originalTextSimple = question.textToPronounce.toLowerCase().replace(/[.,?!]/g, "").trim();
                    const spokenTextSimple = finalTranscript.toLowerCase().replace(/[.,?!]/g, "").trim();
                    if (spokenTextSimple === originalTextSimple) {
                        console.log('Pronunciation correct!');
                        userResults[currentTestQuestionIndex] = true;
                        speakButton.className = 'speak-button correct';
                        speakButton.innerHTML = `<span class="icon">${checkIconSVG}</span> ${finalTranscript}`;
                        if (recognitionInstance && isRecognizing) recognitionInstance.stop();
                    } else {
                        console.log('Pronunciation incorrect. Expected:', originalTextSimple);
                        userResults[currentTestQuestionIndex] = false;
                        speakButton.className = 'speak-button incorrect';
                        speakButton.innerHTML = `<span class="icon">${xIconSVG}</span> ${finalTranscript}`;
                    }
                    pronunciationContinueButton.disabled = false;
                    pronunciationContinueButton.classList.remove('disabled');
                    updateTestProgressBar();
                }
            };

            recognitionInstance.onspeechend = () => {
                console.log('Speech ended (onspeechend).');
                clearTimeout(silenceTimer);
                silenceTimer = setTimeout(() => {
                    if (isRecognizing) {
                         console.log("Silence detected after speech, stopping recognition.");
                         if (recognitionInstance) recognitionInstance.stop();
                    }
                }, 2000);
            };

            recognitionInstance.onend = () => {
                console.log("Speech recognition service disconnected (onend).");
                isRecognizing = false;
                clearTimeout(silenceTimer);
                if (userResults[currentTestQuestionIndex] === null && !speakButton.classList.contains('processing') && !speakButton.classList.contains('correct') && !speakButton.classList.contains('incorrect')) {
                     speakButton.innerHTML = `<span class="icon">${micIconSVG}</span> Tap to START SPEAKING`;
                     speakButton.className = 'speak-button default';
                }
                speakButton.disabled = false;
                playSampleButton.disabled = false;
                if (userResults[currentTestQuestionIndex] !== null && pronunciationContinueButton.disabled) {
                    pronunciationContinueButton.disabled = false;
                    pronunciationContinueButton.classList.remove('disabled');
                }
            };

            recognitionInstance.onerror = (event) => {
                isRecognizing = false;
                clearTimeout(silenceTimer);
                console.error('Speech recognition error:', event.error, event.message);
                speakButton.innerHTML = `<span class="icon">${micIconSVG}</span> Tap to START SPEAKING`;
                speakButton.className = 'speak-button default';
                speakButton.disabled = false;
                playSampleButton.disabled = false;
                pronunciationContinueButton.disabled = false;
                pronunciationContinueButton.classList.remove('disabled');
                let errorMessage = `An error occurred: ${event.error}`;
                if (event.error === 'no-speech') errorMessage = 'No speech was detected. Please try again.';
                else if (event.error === 'audio-capture') errorMessage = 'Audio capture failed. Please ensure your microphone is working and allowed.';
                else if (event.error === 'not-allowed' || event.error === 'service-not-allowed') errorMessage = 'Microphone access denied. Please enable it in your browser settings.';
                else if (event.error === 'network') errorMessage = 'A network error occurred. Please check your connection.';
                alert(errorMessage);
            };
             recognitionInstance.onnomatch = () => {
                isRecognizing = false;
                clearTimeout(silenceTimer);
                console.log("Speech not recognized.");
                speakButton.innerHTML = `<span class="icon">${micIconSVG}</span> Tap to START SPEAKING`;
                speakButton.className = 'speak-button default';
                speakButton.disabled = false;
                playSampleButton.disabled = false;
                pronunciationContinueButton.disabled = false;
                pronunciationContinueButton.classList.remove('disabled');
                alert("Could not recognize speech. Please try again.");
            };
            return recognitionInstance;
        }

        function loadQuestion(questionIndex) {
            stopAllAudio();
            userConstructedSentence = [];
            selectedMatchingItem = { element: null, column: null, value: null, matchId: null };
            matchedPairCount = 0;

            const question = testQuestions[questionIndex];
            testInstructionText.textContent = question.instruction;
            audioSpeedNote.style.display = (question.stimulusType === 'audio' || question.stimulusType === 'audio_file' || question.stimulusType === 'writing') ? 'block' : 'none';
            pronunciationSampleNote.style.display = question.stimulusType === 'pronunciation' ? 'block' : 'none';

            testStimulusContainer.innerHTML = '';
            testOptionsContainer.innerHTML = '';
            testNavigationFooter.innerHTML = '';

            testHeader.style.display = 'flex';
            testProgressBar.style.display = 'flex';
            testQuestionArea.style.display = 'flex';
            testQuestionHeaderDiv.style.display = 'flex';
            testNavigationFooter.style.display = 'block';
            resultDrawer.classList.remove('active');


            if (question.stimulusType === 'pronunciation') {
                renderPronunciationUI(question);
            } else if (question.stimulusType === 'writing') {
                renderWritingUI(question);
            } else if (question.stimulusType === 'translation') {
                renderTranslationUI(question);
            } else if (question.stimulusType === 'matching_pairs') {
                renderMatchingPairsUI(question);
            }
            else {
                if (question.stimulusType === 'image') {
                    const img = document.createElement('img');
                    img.src = question.stimulusContent;
                    img.alt = "Question image";
                    img.classList.add('test-image');
                    img.onerror = function() { this.onerror=null; this.src='https://placehold.co/120x120/cccccc/969696?text=Image+Error'; };
                    testStimulusContainer.appendChild(img);
                } else if (question.stimulusType === 'text') {
                    const p = document.createElement('p');
                    p.textContent = question.stimulusContent;
                    p.classList.add('test-text-stimulus');
                    testStimulusContainer.appendChild(p);
                } else if (question.stimulusType === 'audio' || question.stimulusType === 'audio_file') {
                    renderAudioControls(question, question.stimulusType === 'audio_file' ? question.stimulusContent : null, question.stimulusType === 'audio' ? question.textToPronounce : null);
                }
                renderOptions(question.options);
                renderCheckButton();
            }
            selectedAnswerValue = null;
            updateTestProgressBar();
        }

        function renderOptions(options) {
            options.forEach(opt => {
                const card = document.createElement('div');
                card.classList.add('test-option-card');
                card.textContent = opt.text;
                card.dataset.answer = opt.value;
                card.addEventListener('click', () => {
                    document.querySelectorAll('.test-option-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    selectedAnswerValue = card.dataset.answer;
                    const checkBtn = document.getElementById('checkAnswerButton');
                    if(checkBtn) {
                        checkBtn.disabled = false;
                        checkBtn.classList.remove('disabled');
                    }
                });
                testOptionsContainer.appendChild(card);
            });
        }

        function renderCheckButton(isMatchingPairs = false) {
            const checkBtn = document.createElement('button');
            checkBtn.type = 'button';
            checkBtn.classList.add('check-button');
            checkBtn.id = 'checkAnswerButton';
            checkBtn.textContent = isMatchingPairs ? 'Continue' : 'Check';

            if (isMatchingPairs) {
                checkBtn.disabled = true;
                checkBtn.classList.add('disabled');
            } else {
                checkBtn.disabled = true;
                checkBtn.classList.add('disabled');
            }

            checkBtn.addEventListener('click', handleCheckAnswer);
            testNavigationFooter.appendChild(checkBtn);
        }


        function renderAudioControls(question, audioFileUrl = null, textToSpeakForTTS = null) {
            const audioControlsDiv = document.createElement('div');
            audioControlsDiv.classList.add('audio-controls');

            if (question.stimulusType !== 'pronunciation' && (audioFileUrl || textToSpeakForTTS)) {
                audioControlsDiv.classList.add('audio-controls-horizontal');
            }

            const listenButton = document.createElement('button');
            listenButton.id = `listenButton_q${question.id}`;
            listenButton.classList.add('start-listening-button');
            listenButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M11.536 14.01A8.473 8.473 0 0 0 14.026 8a8.473 8.473 0 0 0-2.49-6.01l-.708.707A7.476 7.476 0 0 1 13.025 8c0 2.071-.84 3.946-2.197 5.303l.708.707z"/><path d="M10.121 12.596A6.48 6.48 0 0 0 12.025 8a6.48 6.48 0 0 0-1.904-4.596l-.707.707A5.483 5.483 0 0 1 11.025 8a5.483 5.483 0 0 1-1.61 3.89l.706.706z"/><path d="M8.707 11.182A4.486 4.486 0 0 0 10.025 8a4.486 4.486 0 0 0-1.318-3.182L8 5.525A3.489 3.489 0 0 1 9.025 8 3.49 3.49 0 0 1 8 10.475l.707.707zM6.717 3.55A.5.5 0 0 1 7 4v8a.5.5 0 0 1-.812.39L3.825 10.5H1.5A.5.5 0 0 1 1 10V6a.5.5 0 0 1 .5-.5h2.325l2.363-1.89a.5.5 0 0 1 .529-.06z"/></svg> Listen`;

            const speedButton = document.createElement('button');
            speedButton.id = `speedCtrlButton_q${question.id}`;
            speedButton.classList.add('audio-speed-button');
            speedButton.textContent = currentPlaybackRate === 1.0 ? 'Speed: 1x' : 'Speed: 0.5x';

            if (audioFileUrl) {
                currentAudioElement = new Audio(audioFileUrl);
                currentAudioElement.onerror = () => { console.error('Error loading audio file:', audioFileUrl); alert('Could not load audio file.'); listenButton.disabled = false; speedButton.disabled = false; };
                currentAudioElement.onplay = () => { listenButton.disabled = true; speedButton.disabled = true; };
                currentAudioElement.onended = () => { listenButton.disabled = false; speedButton.disabled = false; };
                listenButton.addEventListener('click', () => {
                    if (currentAudioElement.paused) { currentAudioElement.playbackRate = currentPlaybackRate; currentAudioElement.play(); }
                    else { currentAudioElement.pause(); currentAudioElement.currentTime = 0; }
                });
                speedButton.addEventListener('click', () => {
                    if (currentAudioElement.paused) {
                        currentPlaybackRate = (currentPlaybackRate === 1.0) ? 0.5 : 1.0;
                        speedButton.textContent = currentPlaybackRate === 1.0 ? 'Speed: 1x' : 'Speed: 0.5x';
                    }
                    else { alert('Cannot change speed while audio is playing.'); }
                });
            } else if (textToSpeakForTTS) {
                listenButton.addEventListener('click', () => speakText(textToSpeakForTTS, listenButton, speedButton));
                speedButton.addEventListener('click', () => {
                    if (speechSynthesis.speaking) { alert('Cannot change speed while audio is playing.'); return; }
                    currentPlaybackRate = (currentPlaybackRate === 1.0) ? 0.5 : 1.0;
                    speedButton.textContent = currentPlaybackRate === 1.0 ? 'Speed: 1x' : 'Speed: 0.5x';
                });
            }
            audioControlsDiv.appendChild(listenButton);
            if (audioFileUrl || textToSpeakForTTS) {
                 audioControlsDiv.appendChild(speedButton);
            }
            testStimulusContainer.appendChild(audioControlsDiv);
        }

        function renderPronunciationUI(question) {
            const textStimulus = document.createElement('p');
            textStimulus.textContent = question.textToPronounce;
            textStimulus.classList.add('pronunciation-text-stimulus', 'my-4');
            testStimulusContainer.appendChild(textStimulus);

            const controlsDiv = document.createElement('div');
            controlsDiv.classList.add('pronunciation-controls');

            const playSampleButton = document.createElement('button');
            playSampleButton.classList.add('play-sample-button');
            playSampleButton.id = 'playSampleButton';
            playSampleButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M11.536 14.01A8.473 8.473 0 0 0 14.026 8a8.473 8.473 0 0 0-2.49-6.01l-.708.707A7.476 7.476 0 0 1 13.025 8c0 2.071-.84 3.946-2.197 5.303l.708.707z"/><path d="M10.121 12.596A6.48 6.48 0 0 0 12.025 8a6.48 6.48 0 0 0-1.904-4.596l-.707.707A5.483 5.483 0 0 1 11.025 8a5.483 5.483 0 0 1-1.61 3.89l.706.706z"/><path d="M8.707 11.182A4.486 4.486 0 0 0 10.025 8a4.486 4.486 0 0 0-1.318-3.182L8 5.525A3.489 3.489 0 0 1 9.025 8 3.49 3.49 0 0 1 8 10.475l.707.707zM6.717 3.55A.5.5 0 0 1 7 4v8a.5.5 0 0 1-.812.39L3.825 10.5H1.5A.5.5 0 0 1 1 10V6a.5.5 0 0 1 .5-.5h2.325l2.363-1.89a.5.5 0 0 1 .529-.06z"/></svg> Play Sample`;

            const speakButton = document.createElement('button');
            speakButton.classList.add('speak-button', 'default');
            speakButton.id = 'speakButton';
            speakButton.innerHTML = `<span class="icon">${micIconSVG}</span><span>Tap to START SPEAKING</span>`;

            if (question.sampleAudioUrl) {
                 currentAudioElement = new Audio(question.sampleAudioUrl);
                 currentAudioElement.onerror = () => { console.error('Error loading sample audio file:', question.sampleAudioUrl); alert('Could not load sample audio.'); playSampleButton.disabled = false; speakButton.disabled = false;};
                 currentAudioElement.onplay = () => { playSampleButton.disabled = true; speakButton.disabled = true;};
                 currentAudioElement.onended = () => { playSampleButton.disabled = false; speakButton.disabled = false;};
                 playSampleButton.addEventListener('click', () => {
                    if (currentAudioElement.paused) { currentAudioElement.play(); }
                    else {currentAudioElement.pause(); currentAudioElement.currentTime = 0;}
                 });
            } else {
                playSampleButton.addEventListener('click', () => speakText(question.textToPronounce, playSampleButton, speakButton));
            }

            controlsDiv.appendChild(playSampleButton);
            controlsDiv.appendChild(speakButton);
            testStimulusContainer.appendChild(controlsDiv);

            const pronunciationContinueButton = document.createElement('button');
            pronunciationContinueButton.type = 'button';
            pronunciationContinueButton.classList.add('pronunciation-continue-button', 'disabled');
            pronunciationContinueButton.id = 'pronunciationContinueButton';
            pronunciationContinueButton.disabled = true;
            pronunciationContinueButton.textContent = 'Continue';
            pronunciationContinueButton.addEventListener('click', handlePronunciationContinue);

            const skipLink = document.createElement('a');
            skipLink.href = "#";
            skipLink.classList.add('pronunciation-skip-link');
            skipLink.id = 'skipPronunciationButton';
            skipLink.textContent = "I can't speak/read right now";
            skipLink.addEventListener('click', (e) => {
                e.preventDefault();
                handlePronunciationSkip();
            });

            testNavigationFooter.appendChild(pronunciationContinueButton);
            testNavigationFooter.appendChild(skipLink);
            recognitionInstance = initializeSpeechRecognition(question, speakButton, playSampleButton, pronunciationContinueButton);
        }

        function renderWritingUI(question) {
            testStimulusContainer.innerHTML = '';
            testOptionsContainer.innerHTML = '';

            if (question.textWithBlank && question.id === 8) {
                const sentenceParts = question.textWithBlank.split('_____');
                const sentenceContainer = document.createElement('div');
                sentenceContainer.className = 'flex items-center justify-center gap-x-2 test-text-stimulus my-4';

                const part1 = document.createElement('span');
                part1.textContent = sentenceParts[0].trim();
                sentenceContainer.appendChild(part1);

                const inputField = document.createElement('input');
                inputField.type = 'text';
                inputField.id = 'writingAnswerInput';
                inputField.className = 'writing-input-field';
                inputField.style.width = '144px';
                inputField.style.margin = '0';
                inputField.setAttribute('aria-label', 'Type the missing word');


                inputField.addEventListener('input', () => {
                    const checkBtn = document.getElementById('checkAnswerButton');
                    if (checkBtn) {
                        checkBtn.disabled = !inputField.value.trim();
                        checkBtn.classList.toggle('disabled', !inputField.value.trim());
                    }
                });
                sentenceContainer.appendChild(inputField);

                const part2 = document.createElement('span');
                part2.textContent = sentenceParts[1].trim();
                sentenceContainer.appendChild(part2);

                testStimulusContainer.appendChild(sentenceContainer);
                renderAudioControls(question, question.audioUrl);

            } else {
                if (question.textWithBlank) {
                    const p = document.createElement('p');
                    p.textContent = question.textWithBlank;
                    p.classList.add('test-text-stimulus', 'my-4');
                    testStimulusContainer.appendChild(p);
                }
                renderAudioControls(question, question.audioUrl);

                const inputWrapper = document.createElement('div');
                inputWrapper.className = 'w-full flex justify-center mt-4';

                const inputField = document.createElement('input');
                inputField.type = 'text';
                inputField.id = 'writingAnswerInput';
                inputField.classList.add('writing-input-field');
                inputField.setAttribute('aria-label', 'Type what you heard');


                inputField.addEventListener('input', () => {
                    const checkBtn = document.getElementById('checkAnswerButton');
                    if (checkBtn) {
                        checkBtn.disabled = !inputField.value.trim();
                        checkBtn.classList.toggle('disabled', !inputField.value.trim());
                    }
                });
                inputWrapper.appendChild(inputField);
                testOptionsContainer.appendChild(inputWrapper);
            }
            renderCheckButton();
        }

        function renderTranslationUI(question) {
            testStimulusContainer.innerHTML = '';
            testOptionsContainer.innerHTML = '';
            userConstructedSentence = [];

            const sentenceEl = document.createElement('p');
            sentenceEl.textContent = question.koreanSentence || question.englishSentence;
            sentenceEl.classList.add('sentence-stimulus');
            testStimulusContainer.appendChild(sentenceEl);

            const userTranslationArea = document.createElement('div');
            userTranslationArea.id = 'userTranslationArea';
            userTranslationArea.classList.add('user-translation-area');
            testStimulusContainer.appendChild(userTranslationArea);

            const wordBankContainer = document.createElement('div');
            wordBankContainer.id = 'wordBankContainer';
            wordBankContainer.classList.add('word-bank-container');

            const shuffledWordBank = [...question.wordBank].sort(() => Math.random() - 0.5);

            shuffledWordBank.forEach((word, index) => {
                const wordButton = document.createElement('button');
                wordButton.textContent = word;
                wordButton.classList.add('word-bank-button');
                wordButton.dataset.word = word;
                wordButton.dataset.originalIndex = index;

                wordButton.addEventListener('click', () => {
                    const wordPill = document.createElement('span');
                    wordPill.textContent = word;
                    wordPill.classList.add('word-pill');
                    const pillId = `pill-${question.id}-${index}-${userTranslationArea.children.length}`;
                    wordPill.id = pillId;
                    wordPill.dataset.sourceButtonId = `word-bank-btn-${question.id}-${index}`;


                    wordPill.addEventListener('click', () => {
                        userTranslationArea.removeChild(wordPill);
                        const itemIndexToRemove = userConstructedSentence.findIndex(item => item.id === pillId);
                        if (itemIndexToRemove > -1) {
                            userConstructedSentence.splice(itemIndexToRemove, 1);
                        }

                        const sourceButton = document.getElementById(wordPill.dataset.sourceButtonId);
                        if (sourceButton) {
                            sourceButton.disabled = false;
                        }
                        updateCheckButtonStateForTranslation();
                    });

                    userTranslationArea.appendChild(wordPill);
                    userConstructedSentence.push({ text: word, id: pillId });

                    wordButton.disabled = true;
                    updateCheckButtonStateForTranslation();
                });
                wordButton.id = `word-bank-btn-${question.id}-${index}`;
                wordBankContainer.appendChild(wordButton);
            });
            testOptionsContainer.appendChild(wordBankContainer);

            renderCheckButton();
            document.getElementById('checkAnswerButton').disabled = true;
            document.getElementById('checkAnswerButton').classList.add('disabled');
        }

        function updateCheckButtonStateForTranslation() {
            const checkBtn = document.getElementById('checkAnswerButton');
            if (checkBtn) {
                const translationArea = document.getElementById('userTranslationArea');
                if (translationArea && translationArea.hasChildNodes()) {
                    checkBtn.disabled = false;
                    checkBtn.classList.remove('disabled');
                } else {
                    checkBtn.disabled = true;
                    checkBtn.classList.add('disabled');
                }
            }
        }

        function renderMatchingPairsUI(question) {
            testStimulusContainer.innerHTML = '';
            testOptionsContainer.innerHTML = '';
            matchedPairCount = 0;
            selectedMatchingItem = { element: null, column: null, value: null, matchId: null };

            const matchingContainer = document.createElement('div');
            matchingContainer.classList.add('matching-pairs-container');

            const leftColumn = document.createElement('div');
            leftColumn.classList.add('matching-column');
            leftColumn.id = 'matching-column-left';

            const rightColumn = document.createElement('div');
            rightColumn.classList.add('matching-column');
            rightColumn.id = 'matching-column-right';

            const shuffledPairs = [...question.pairs].sort(() => Math.random() - 0.5);
            let leftItems = [];
            let rightItems = [];

            shuffledPairs.forEach(pair => {
                leftItems.push({ text: pair.left, id: pair.id + '_left_col', matchId: pair.matchId, originalText: pair.left });
                rightItems.push({ text: pair.right, id: pair.id + '_right_col', matchId: pair.matchId, originalText: pair.right });
            });

            leftItems.sort(() => Math.random() - 0.5);
            rightItems.sort(() => Math.random() - 0.5);


            leftItems.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.textContent = item.text;
                itemEl.classList.add('matching-item');
                itemEl.dataset.value = item.originalText;
                itemEl.dataset.column = 'left';
                itemEl.dataset.matchId = item.matchId;
                itemEl.id = item.id;

                itemEl.addEventListener('click', handleMatchingItemClick);
                leftColumn.appendChild(itemEl);
            });

            rightItems.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.textContent = item.text;
                itemEl.classList.add('matching-item');
                itemEl.dataset.value = item.originalText;
                itemEl.dataset.column = 'right';
                itemEl.dataset.matchId = item.matchId;
                itemEl.id = item.id;

                itemEl.addEventListener('click', handleMatchingItemClick);
                rightColumn.appendChild(itemEl);
            });

            matchingContainer.appendChild(leftColumn);
            matchingContainer.appendChild(rightColumn);
            testOptionsContainer.appendChild(matchingContainer);

            renderCheckButton(true);
        }

        function handleMatchingItemClick(event) {
            const clickedItem = event.target;
            if (clickedItem.classList.contains('correct') || clickedItem.disabled) return;

            const column = clickedItem.dataset.column;
            const value = clickedItem.dataset.value;
            const matchId = clickedItem.dataset.matchId;

            if (!selectedMatchingItem.element) {
                if (clickedItem.classList.contains('selected')) {
                    clickedItem.classList.remove('selected');
                    selectedMatchingItem = { element: null, column: null, value: null, matchId: null };
                } else {
                    const currentlySelected = document.querySelector(`.matching-item.selected[data-column="${column}"]`);
                    if (currentlySelected) {
                        currentlySelected.classList.remove('selected');
                    }
                    clickedItem.classList.add('selected');
                    selectedMatchingItem = { element: clickedItem, column: column, value: value, matchId: matchId };
                }
            } else {
                if (selectedMatchingItem.column === column) {
                    selectedMatchingItem.element.classList.remove('selected');
                    clickedItem.classList.add('selected');
                    selectedMatchingItem = { element: clickedItem, column: column, value: value, matchId: matchId };
                } else {
                    if (selectedMatchingItem.matchId === matchId) {
                        selectedMatchingItem.element.classList.add('correct');
                        clickedItem.classList.add('correct');
                        selectedMatchingItem.element.disabled = true;
                        clickedItem.disabled = true;
                        selectedMatchingItem.element.classList.remove('selected');
                        clickedItem.classList.remove('selected');

                        matchedPairCount++;
                        if (matchedPairCount === testQuestions[currentTestQuestionIndex].pairs.length) {
                            const checkBtn = document.getElementById('checkAnswerButton');
                            if (checkBtn) {
                                checkBtn.disabled = false;
                                checkBtn.classList.remove('disabled');
                            }
                            userResults[currentTestQuestionIndex] = true;
                            updateTestProgressBar();
                        }
                        selectedMatchingItem = { element: null, column: null, value: null, matchId: null };
                    } else {
                        selectedMatchingItem.element.classList.add('incorrect');
                        clickedItem.classList.add('incorrect');

                        setTimeout(() => {
                            selectedMatchingItem.element.classList.remove('incorrect', 'selected');
                            clickedItem.classList.remove('incorrect');
                            selectedMatchingItem = { element: null, column: null, value: null, matchId: null };
                        }, 800);
                    }
                }
            }
        }


        function handleCheckAnswer() {
             const question = testQuestions[currentTestQuestionIndex];
             let isCorrect = false;

             if (question.stimulusType === 'writing') {
                const writingInput = document.getElementById('writingAnswerInput');
                if (writingInput) {
                    const userAnswer = writingInput.value.trim();
                    isCorrect = userAnswer.toLowerCase() === question.correctAnswerValue.toLowerCase();
                }
             } else if (question.stimulusType === 'translation') {
                const constructedWords = userConstructedSentence.map(item => item.text);
                if (constructedWords.length === question.correctTranslation.length) {
                    isCorrect = constructedWords.every((word, index) => word === question.correctTranslation[index]);
                }
             } else if (question.stimulusType === 'matching_pairs') {
                isCorrect = (matchedPairCount === question.pairs.length);
                if (isCorrect && currentTestQuestionIndex === testQuestions.length - 1) {
                    userResults[currentTestQuestionIndex] = true;
                    updateTestProgressBar();
                    showFinalResultsScreen();
                    return;
                }
                if (isCorrect) {
                    showResultDrawer(true);
                    return;
                } else {
                    alert("Please match all pairs correctly before continuing.");
                    return;
                }
             } else if (selectedAnswerValue) {
                isCorrect = selectedAnswerValue === question.correctAnswerValue;
             }

            userResults[currentTestQuestionIndex] = isCorrect;
            updateTestProgressBar();
            showResultDrawer(isCorrect);
            const checkBtn = document.getElementById('checkAnswerButton');
            if(checkBtn && question.stimulusType !== 'matching_pairs') {
                checkBtn.disabled = true;
                checkBtn.classList.add('disabled');
            }
        }

        resultContinueButton.addEventListener('click', () => {
            hideResultDrawer();
            currentTestQuestionIndex++;
            if (currentTestQuestionIndex >= testQuestions.length) {
                showFinalResultsScreen();
            } else {
                loadQuestion(currentTestQuestionIndex);
                selectedAnswerValue = null;
                userConstructedSentence = [];
                selectedMatchingItem = { element: null, column: null, value: null, matchId: null };
                matchedPairCount = 0;
            }
        });

        function showFinalResultsScreen() {
            testHeader.style.display = 'none';
            testProgressBar.style.display = 'none';
            testQuestionArea.innerHTML = '';
            testNavigationFooter.innerHTML = '';
            resultDrawer.classList.remove('active');

            const correctAnswers = userResults.filter(result => result === true).length;
            const totalQuestions = testQuestions.length;

            const finalResultContainer = document.createElement('div');
            finalResultContainer.classList.add('final-result-container');

            const bubbleText = document.createElement('div');
            bubbleText.classList.add('final-result-mascot-bubble');

            const lottieContainer = document.createElement('div');
            lottieContainer.classList.add('lottie-animation-container');
            const lottiePlayer = document.createElement('lottie-player');
            lottiePlayer.setAttribute('autoplay', '');
            lottiePlayer.setAttribute('loop', '');
            lottiePlayer.style.width = '100%';
            lottiePlayer.style.height = '100%';


            const yourResultLabel = document.createElement('p');
            yourResultLabel.classList.add('your-result-text');
            yourResultLabel.textContent = "YOUR RESULT";

            const scoreText = document.createElement('p');
            scoreText.classList.add('final-score-text');
            scoreText.textContent = `${correctAnswers}/${totalQuestions}`;

            const messageText = document.createElement('p');
            messageText.classList.add('final-message-text');
            messageText.textContent = "You've completed the test. We will provide the fittest learning path base on your result";

            const spinnerDiv = document.createElement('div');
            spinnerDiv.classList.add('spinner');

            if (correctAnswers >= 6) {
                bubbleText.textContent = "Amazing! You did it";
                bubbleText.classList.add('amazing');
                scoreText.classList.add('amazing-score');
                lottiePlayer.setAttribute('src', 'https://res.cloudinary.com/middo-vn/raw/upload/v1747294233/cheer.json');
            } else {
                bubbleText.textContent = "Don't worry! I will help you level up";
                scoreText.classList.add('needs-improvement-score');
                lottiePlayer.setAttribute('src', 'https://res.cloudinary.com/middo-vn/raw/upload/v1747294346/sad.json');
            }
            lottieContainer.appendChild(lottiePlayer);

            finalResultContainer.appendChild(bubbleText);
            finalResultContainer.appendChild(lottieContainer);
            finalResultContainer.appendChild(yourResultLabel);
            finalResultContainer.appendChild(scoreText);
            finalResultContainer.appendChild(messageText);
            finalResultContainer.appendChild(spinnerDiv);

            while (pageContentWrapper.firstChild) {
                pageContentWrapper.removeChild(pageContentWrapper.firstChild);
            }
            pageContentWrapper.appendChild(finalResultContainer);

            setTimeout(() => {
                window.location.href = 'learning_path.html';
            }, 5000);
        }


        function handlePronunciationContinue() {
            hideResultDrawer();
            currentTestQuestionIndex++;
             if (currentTestQuestionIndex >= testQuestions.length) {
                showFinalResultsScreen();
            } else {
                loadQuestion(currentTestQuestionIndex);
                selectedAnswerValue = null;
            }
        }

        function handlePronunciationSkip() {
            console.log('Pronunciation skipped for question:', testQuestions[currentTestQuestionIndex].id);
            userResults[currentTestQuestionIndex] = 'skipped';
            updateTestProgressBar();
            hideResultDrawer();
            currentTestQuestionIndex++;
             if (currentTestQuestionIndex >= testQuestions.length) {
                showFinalResultsScreen();
            } else {
                loadQuestion(currentTestQuestionIndex);
                selectedAnswerValue = null;
            }
        }

        function speakText(textToSpeak, buttonToDisable1, buttonToDisable2) {
            console.log('Attempting to speak with TTS:', textToSpeak, 'with rate:', currentPlaybackRate);
            if (typeof speechSynthesis === 'undefined') {
                alert('Speech Synthesis API is not supported in this browser.');
                if(buttonToDisable1) buttonToDisable1.disabled = false;
                if(buttonToDisable2) buttonToDisable2.disabled = false;
                return;
            }
            if (speechSynthesis.speaking || speechSynthesis.pending) {
                console.log('Cancelling previous/pending TTS speech.');
                speechSynthesis.cancel();
            }
            setTimeout(() => {
                if (speechSynthesis.speaking) {
                    console.warn('Speech synthesis is still busy after cancel. Try again.');
                    if(buttonToDisable1) buttonToDisable1.disabled = false;
                    if(buttonToDisable2) buttonToDisable2.disabled = false;
                    alert("Speech system is busy. Please try again in a moment.");
                    return;
                }
                currentSpeech = new SpeechSynthesisUtterance(textToSpeak);
                currentSpeech.lang = 'ko-KR';
                currentSpeech.rate = currentPlaybackRate;
                const koreanVoice = ttsVoices.find(voice => voice.lang === 'ko-KR');
                if (koreanVoice) {
                    currentSpeech.voice = koreanVoice;
                    console.log("Using Korean voice:", koreanVoice.name);
                } else if (ttsVoices.length > 0) {
                     console.warn("No Korean (ko-KR) voice found. Using default system voice for TTS.");
                } else {
                    console.warn("Voice list is empty. TTS might use a default or fail.");
                }
                if(buttonToDisable1) buttonToDisable1.disabled = true;
                if(buttonToDisable2) buttonToDisable2.disabled = true;
                currentSpeech.onstart = () => { console.log('TTS Speech started for:', textToSpeak); };
                currentSpeech.onend = () => {
                    console.log('TTS Speech finished for:', textToSpeak);
                    if(buttonToDisable1) buttonToDisable1.disabled = false;
                    if(buttonToDisable2) buttonToDisable2.disabled = false;
                    currentSpeech = null;
                };
                currentSpeech.onerror = (event) => {
                    console.error('TTS Speech synthesis error for:', textToSpeak, 'Error:', event.error, 'Message:', event.message);
                    if(buttonToDisable1) buttonToDisable1.disabled = false;
                    if(buttonToDisable2) buttonToDisable2.disabled = false;
                    currentSpeech = null;
                    alert(`Sorry, TTS failed: ${event.error}. A Korean voice might not be installed or available on your system.`);
                };
                speechSynthesis.speak(currentSpeech);
            }, 150);
        }

        function showResultDrawer(isCorrect) {
            resultDrawerIconContainer.classList.remove('correct', 'incorrect');
            resultDrawerTitle.classList.remove('correct', 'incorrect');
            resultContinueButton.classList.remove('correct', 'incorrect');
            resultDrawer.style.backgroundColor = 'white';
            const currentQuestion = testQuestions[currentTestQuestionIndex];
            if (isCorrect) {
                resultDrawerIconContainer.innerHTML = iconCorrectSVG;
                resultDrawerIconContainer.classList.add('correct');
                resultDrawerTitle.textContent = "Correct!";
                resultDrawerTitle.classList.add('correct');
                resultDrawerMessage.innerHTML = `Answer: <strong>${currentQuestion.correctAnswerDisplay}</strong>`;
                resultContinueButton.classList.add('correct');
            } else {
                resultDrawerIconContainer.innerHTML = iconIncorrectSVG;
                resultDrawerIconContainer.classList.add('incorrect');
                resultDrawerTitle.textContent = "Incorrect!";
                resultDrawerTitle.classList.add('incorrect');
                resultDrawerMessage.innerHTML = `Correct answer: <strong>${currentQuestion.correctAnswerDisplay}</strong>`;
                resultContinueButton.classList.add('incorrect');
            }
            resultDrawer.classList.add('active');
        }

        function hideResultDrawer() {
            resultDrawer.classList.remove('active');
        }


        closeTestButton.addEventListener('click', () => {
            stopAllAudio();
            console.log('Close test button clicked, redirecting to personalization_flow.html');
            window.location.href = "personalization_flow.html";
        });

        function restartTest() {
            currentTestQuestionIndex = 0;
            userResults = new Array(testQuestions.length).fill(null);
            selectedAnswerValue = null;
            userConstructedSentence = [];
            selectedMatchingItem = { element: null, column: null, value: null, matchId: null };
            matchedPairCount = 0;

            const finalResultScreen = document.querySelector('.final-result-container');
            if (finalResultScreen) {
                pageContentWrapper.removeChild(finalResultScreen);
            }
            createProgressBar();
            loadQuestion(currentTestQuestionIndex);
        }

        createProgressBar();
        loadQuestion(currentTestQuestionIndex);

    </script>
</body>
</html>
